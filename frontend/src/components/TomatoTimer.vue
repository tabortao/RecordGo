<template>
  <!-- ä¸­æ–‡æ³¨é‡Šï¼šç•ªèŒ„é’Ÿç»„ä»¶ï¼ˆå¢å¼ºç‰ˆï¼‰ï¼Œæ”¯æŒå€’è®¡æ—¶/æ­£è®¡æ—¶ã€é¢„è®¾ä¸è‡ªå®šä¹‰ã€å¼€å§‹/æš‚åœ/ç»§ç»­/å®Œæˆ -->
  <!-- ä¸­æ–‡æ³¨é‡Šï¼šå®¹å™¨æ”¹ä¸ºå……æ»¡è§†å£é«˜åº¦ï¼Œåº•éƒ¨åŒºåŸŸæ›´è´´è¿‘é¡µé¢åº•éƒ¨ -->
  <div class="relative p-4 flex flex-col justify-between">

    <!-- ä¸­æ–‡æ³¨é‡Šï¼šç§»é™¤ç»„ä»¶å†…éƒ¨æ ‡é¢˜ï¼Œé¿å…ä¸å¼¹çª—æ ‡é¢˜é‡å¤æ˜¾ç¤º -->

    <!-- ä¸­æ–‡æ³¨é‡Šï¼šæ—¶é—´å±…ä¸­ï¼Œå³ä¾§æä¾›æ¨¡å¼åˆ‡æ¢å›¾æ ‡ï¼›å¤‡æ³¨åœ¨æ—¶é—´ä¸‹æ–¹æ˜¾ç¤ºä¸ºç°è‰²å°å­— -->
    <!-- ä¸­æ–‡æ³¨é‡Šï¼šå¤œé—´ä¸»é¢˜ - æ—¶é—´ä¸å›¾æ ‡é¢œè‰²è°ƒæ•´ä¸ºæµ…è‰²ï¼ˆ#B8CEE8ï¼‰ï¼Œä½¿å¯¹æ¯”æ¸…æ™° -->
    <!-- ä¸­æ–‡æ³¨é‡Šï¼šä¸­éƒ¨åŒºåŸŸä½¿ç”¨ flex-1 å±…ä¸­ï¼Œè®©æ—¶é—´æ˜¾ç¤ºä½äºé¡¶éƒ¨ä¸åº•éƒ¨ä¹‹é—´çš„æ­£ä¸­ -->
    <div class="flex-1 flex flex-col items-center justify-center gap-3 pt-16 pb-32">
      <!-- ä¸­æ–‡æ³¨é‡Šï¼šè¡¨ç›˜æ ·å¼ + æ•°å­—æ—¶é—´ï¼šæµ…æ©™è‰²è¿›åº¦åœˆåœ¨å€’è®¡æ—¶æ¨¡å¼ä¸‹é€æ¸å‡å°‘ -->
      <div class="relative w-64 h-64">
        <svg width="256" height="256" viewBox="0 0 256 256">
          <!-- èƒŒæ™¯è½¨é“ -->
          <circle cx="128" cy="128" r="100" stroke="#4a4a48" stroke-width="16" fill="none" />
          <!-- é’Ÿè¡¨åˆ»åº¦ï¼š60 ä¸ªåˆ»åº¦ï¼Œ5 çš„å€æ•°åŠ ç²—åŠ é•¿ -->
          <g stroke="#B8CEE8" opacity="0.7">
            <template v-for="i in 60" :key="i">
              <line
                x1="128"
                y1="28"
                x2="128"
                :y2="((i-1) % 5 === 0) ? 44 : 36"
                :stroke-width="((i-1) % 5 === 0) ? 2.5 : 1.5"
                :transform="'rotate(' + ((i-1) * 6) + ' 128 128)'"
              />
            </template>
          </g>
          <!-- è¿›åº¦å¼§çº¿ï¼šå€’è®¡æ—¶å‰©ä½™æ¯”ä¾‹ï¼Œèµ·ç‚¹åœ¨ä¸Šæ–¹ï¼ˆ-90Â°æ—‹è½¬ï¼‰ -->
          <circle
            cx="128" cy="128" r="100"
            stroke="#F4A261" stroke-width="16" fill="none" stroke-linecap="butt"
            :style="{ transition: 'stroke-dashoffset .3s linear' }"
            :stroke-dasharray="circumference"
            :stroke-dashoffset="dashOffset"
            transform="rotate(-90 128 128)"
          />
          <!-- è¿›åº¦ç¯åˆ†é’Ÿåˆ†å‰²çº¿ï¼ˆç™½è‰²ï¼‰ï¼šæ¯ 1 åˆ†é’Ÿä¸€æ¡ï¼Œè¦†ç›–åœ¨è¿›åº¦ç¯ä¹‹ä¸Šï¼Œä½¿æ©™è‰²ç¯å‘ˆé—´æ–­ -->
          <g stroke="#FFFFFF" opacity="0.85">
            <template v-for="i in 60" :key="'sep-'+i">
              <line
                x1="128"
                y1="20"
                x2="128"
                y2="36"
                stroke-width="3"
                :transform="'rotate(' + ((i-1) * 6) + ' 128 128)'"
              />
            </template>
          </g>
          <!-- æ•°å­—åˆ»åº¦ï¼ˆ0ã€5ã€10...55ï¼‰ -->
          <g fill="#B8CEE8" font-size="12" opacity="0.95" font-family="monospace" font-weight="700">
            <template v-for="lbl in dialLabels" :key="lbl.m">
              <text :x="lbl.x" :y="lbl.y" text-anchor="middle" dominant-baseline="middle">{{ lbl.m }}</text>
            </template>
          </g>
        </svg>
        <!-- æ•°å­—æ—¶é—´ç½®äºè¡¨ç›˜ä¸­å¿ƒ -->
        <!-- ä¸­æ–‡æ³¨é‡Šï¼šä¸­å¿ƒæ—¶é—´åŒºåŸŸæ”¹ä¸ºä¸Šä¸‹ç»“æ„ï¼›ä¸Šæ–¹ç¬‘è„¸ã€ä¸‹æ–¹çº¢è‰²ç•ªèŒ„å›¾æ ‡ -->
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="flex flex-col items-center justify-center">
            <div class="text-xl select-none" :style="{ color: '#B8CEE8' }">ğŸ˜Š</div>
            <div class="text-6xl font-mono" :style="{ color: '#B8CEE8' }">{{ mm }}:{{ ss }}</div>
            <img src="@/assets/tomato.png" alt="ç•ªèŒ„" class="w-6 h-6 mt-2 select-none" />
          </div>
        </div>
      </div>
      <!-- æ¨¡å¼åˆ‡æ¢å›¾æ ‡ç½®äºæ—¶é—´ä¸‹æ–¹ï¼Œé¿å…ä¸ä¸­å¿ƒé‡å  -->
      <div>
        <el-icon
          class="cursor-pointer"
          :title="mode==='countdown' ? 'åˆ‡æ¢ä¸ºæ­£è®¡æ—¶' : 'åˆ‡æ¢ä¸ºå€’è®¡æ—¶'"
          :style="{ color: '#B8CEE8' }"
          @click="toggleMode"
        >
          <RefreshRight />
        </el-icon>
      </div>
      <!-- ä¸­æ–‡æ³¨é‡Šï¼šç§»é™¤é¢„è®¡æ—¶é•¿çš„å°å­—æç¤ºï¼Œç•Œé¢æ›´ç®€æ´ -->
    </div>

    <!-- ä¸­æ–‡æ³¨é‡Šï¼šåº•éƒ¨åŒºåŸŸ - åŒ…å«æ—¶é—´é¢„è®¾/è‡ªå®šä¹‰ä¸æ§åˆ¶æŒ‰é’®ï¼Œæ›´è´´è¿‘é¡µé¢åº•éƒ¨ -->
    <div class="fixed bottom-12 left-0 right-0 flex items-center justify-center" data-bottom="tomato-controls">
      <button
        class="w-20 h-20 rounded-full shadow-lg font-bold select-none text-[16px]"
        :style="{ backgroundColor: '#3a3a38', color: '#B8CEE8', boxShadow: '0 0 0 1px #4a4a48 inset' }"
        @click="onCircleTap"
        @pointerdown="onCircleDown"
        @pointerup="onCircleUp"
        @pointerleave="onCircleUp"
      >
        {{ running ? 'æš‚åœ' : (started ? 'ç»§ç»­' : 'å¼€å§‹') }}
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
// ä¸­æ–‡æ³¨é‡Šï¼šæ¥æ”¶ä»»åŠ¡åä¸å¤‡æ³¨ + å·¥ä½œ/ä¼‘æ¯åˆ†é’Ÿæ•°ï¼ˆåˆå¹¶å®šä¹‰ï¼‰
// ä¸­æ–‡æ³¨é‡Šï¼šç•ªèŒ„é’Ÿé€»è¾‘ï¼Œå·¥ä½œä¸ä¼‘æ¯ä¸¤ä¸ªé˜¶æ®µï¼Œå€’è®¡æ—¶ç»“æŸååˆ‡æ¢é˜¶æ®µå¹¶åœ¨å·¥ä½œç»“æŸæ—¶è§¦å‘ complete äº‹ä»¶
import { computed, onMounted, onUnmounted, ref, watch } from 'vue'
import { ElMessage } from 'element-plus'
import { useAppState } from '@/stores/appState'
import { speak } from '@/utils/speech'
import JingleBellUrl from '@/assets/audio/JingleBell.mp3'
import { RefreshRight } from '@element-plus/icons-vue'

// ä¸­æ–‡æ³¨é‡Šï¼šæ–°å¢ taskIdï¼Œä¾¿äºæ‚¬æµ®çƒè¿”å›åˆ°ç‹¬ç«‹ç•ªèŒ„é’Ÿé¡µé¢
const props = defineProps<{ workMinutes?: number; breakMinutes?: number; taskName?: string; taskRemark?: string; taskId?: number }>()
const emit = defineEmits<{ (e: 'complete', seconds: number): void }>()
const store = useAppState()

function playBell(): Promise<void> {
  return new Promise((resolve) => {
    try {
      const audio = new Audio(JingleBellUrl)
      let done = false
      const finish = () => { if (!done) { done = true; resolve() } }
      audio.onended = finish
      audio.onerror = finish
      const p = audio.play()
      if (p && typeof (p as any).catch === 'function') (p as any).catch(finish)
    } catch {
      resolve()
    }
  })
}

async function playEndCue() {
  await playBell().catch(() => {})
  const text = (store.tomato.countdownEndText || '').trim()
  if (!store.tomato.countdownEndSpeakEnabled) return
  if (store.speech.enabled && text) {
    speak(text, { voiceURI: store.speech.voiceURI || undefined, rate: store.speech.rate, pitch: store.speech.pitch }).catch(() => {})
  }
}

const workM = computed(() => props.workMinutes ?? store.tomato.durationMinutes ?? 20)
const breakM = computed(() => props.breakMinutes ?? 5)

type Phase = 'work' | 'break'
const phase = ref<Phase>('work')
const mode = ref<'countdown' | 'countup'>(store.tomato.runningMode ?? store.tomato.mode)
const running = ref(store.tomato.running)
const remaining = ref(store.tomato.running ? (store.tomato.remainingSeconds || (mode.value === 'countdown' ? workM.value * 60 : 0)) : (mode.value === 'countdown' ? workM.value * 60 : 0))
const started = ref(false)
// è‡ªå®šä¹‰åˆ†é’Ÿå·²è¿ç§»åˆ°é¡µé¢çº§è°ƒæ•´
let pressTimer: any = null
function onCircleTap() { if (!started.value) start(); else togglePauseResume() }
function onCircleDown() { if (pressTimer) clearTimeout(pressTimer); pressTimer = setTimeout(() => { complete() }, 2000) }
function onCircleUp() { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null } }
let timer: any = null
// ä¸­æ–‡æ³¨é‡Šï¼šå¢™é’Ÿæ—¶é—´æˆ³ï¼Œæ”¯æŒé”å±/åå°åç»§ç»­å‡†ç¡®è®¡æ—¶
const startAtMs = ref<number | null>(store.tomato.startAtMs ?? null)
const endAtMs = ref<number | null>(store.tomato.endAtMs ?? null)
// ä¸­æ–‡æ³¨é‡Šï¼šWake Lock API å“¨å…µï¼Œç”¨äºä¿æŒè®¾å¤‡å¸¸äº®ï¼ˆç§»åŠ¨ç«¯ï¼‰ï¼›iOS Chrome å›é€€ä¸ºéšè—è§†é¢‘å¾ªç¯æ’­æ”¾
let wakeLock: any = null
let keepAwakeVideo: HTMLVideoElement | null = null
function ensureVideoFallback() {
  try {
    if (keepAwakeVideo) { keepAwakeVideo.play().catch(() => {}); return }
    const video = document.createElement('video')
    video.setAttribute('playsinline', '')
    video.muted = true
    video.loop = true
    video.style.position = 'fixed'
    video.style.opacity = '0'
    video.style.width = '1px'
    video.style.height = '1px'
    video.style.pointerEvents = 'none'
    video.style.zIndex = '-1'
    const addSource = (type: string, dataURI: string) => {
      const s = document.createElement('source')
      s.src = dataURI
      s.type = `video/${type}`
      video.appendChild(s)
    }
    // ä¸­æ–‡æ³¨é‡Šï¼šå†…ç½®æå°çš„è§†é¢‘æ•°æ®ï¼Œæ¥æºäºå…¬å¼€ç¤ºä¾‹ï¼ˆç”¨äºä¿æŒå”¤é†’ï¼‰
    addSource('webm', 'data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=')
    addSource('mp4', 'data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw==')
    document.body.appendChild(video)
    keepAwakeVideo = video
    video.play().catch(() => {})
  } catch {}
}
async function requestWakeLock() {
  try {
    const nav: any = navigator as any
    if (nav.wakeLock && typeof nav.wakeLock.request === 'function') {
      wakeLock = await nav.wakeLock.request('screen')
      // ä¸­æ–‡æ³¨é‡Šï¼šè‹¥è¢«ç³»ç»Ÿé‡Šæ”¾ï¼Œåˆ™åœ¨å¯è§ä¸”ä»åœ¨è®¡æ—¶æ—¶å°è¯•é‡æ–°ç”³è¯·
      wakeLock.addEventListener?.('release', () => {
        wakeLock = null
        if (document.visibilityState === 'visible' && running.value) {
          requestWakeLock().catch(() => {})
        }
      })
    } else {
      // ä¸­æ–‡æ³¨é‡Šï¼šiOS Chrome ç­‰ä¸æ”¯æŒ Wake Lockï¼Œä½¿ç”¨éšè—è§†é¢‘å›é€€
      ensureVideoFallback()
    }
  } catch (e: any) {
    // ä¸­æ–‡æ³¨é‡Šï¼šWake Lock å¤±è´¥æ—¶å¯ç”¨è§†é¢‘å›é€€æ–¹æ¡ˆ
    ensureVideoFallback()
    ElMessage.warning('ä¿æŒå¸¸äº®å¤±è´¥ï¼Œå·²å¯ç”¨å…¼å®¹æ–¹æ¡ˆ')
  }
}
async function releaseWakeLock() {
  try { if (wakeLock) { await wakeLock.release(); wakeLock = null } } catch {}
  try { if (keepAwakeVideo) { keepAwakeVideo.pause(); keepAwakeVideo.remove(); keepAwakeVideo = null } } catch {}
}

// ä¸­æ–‡æ³¨é‡Šï¼šç§»é™¤æœªä½¿ç”¨çš„æ–‡æœ¬è®¡ç®—ï¼Œé¿å…æ— ç”¨è­¦å‘Š
const mm = computed(() => String(Math.floor(remaining.value / 60)).padStart(2, '0'))
const ss = computed(() => String(remaining.value % 60).padStart(2, '0'))
// ä¸­æ–‡æ³¨é‡Šï¼šè¡¨ç›˜è¿›åº¦æŒ‰ 60 åˆ†é’Ÿæ»¡åœˆæ˜ å°„ã€‚å€’è®¡æ—¶æ˜¾ç¤ºå‰©ä½™ä¸ 60 çš„æ¯”ä¾‹ï¼Œæ­£è®¡æ—¶æ˜¾ç¤ºå‰©ä½™ï¼ˆè®¡åˆ’-å·²ç”¨ï¼‰ä¸ 60 çš„æ¯”ä¾‹ã€‚
const dialRatio = computed(() => {
  if (mode.value === 'countdown') {
    // å€’è®¡æ—¶ï¼šæ˜¾ç¤ºå‰©ä½™ç›¸å¯¹ 60 åˆ†é’Ÿçš„æ¯”ä¾‹ï¼ˆé€æ­¥å‡å°‘ï¼‰
    return Math.min(1, Math.max(0, remaining.value / 3600))
  }
  // æ­£è®¡æ—¶ï¼šæ˜¾ç¤ºå·²ç”¨æ—¶é—´ç›¸å¯¹ 60 åˆ†é’Ÿçš„æ¯”ä¾‹ï¼ˆä» 0 é€æ­¥å¢åŠ ï¼‰
  return Math.min(1, Math.max(0, remaining.value / 3600))
})
const circumference = 2 * Math.PI * 100
const dashOffset = computed(() => circumference * (1 - dialRatio.value))
// ä¸­æ–‡æ³¨é‡Šï¼šæ•°å­—åˆ»åº¦ä½ç½®ï¼ˆ0ã€5ã€10...55ï¼‰ï¼Œæ”¾åˆ°è¡¨ç›˜å¤–ä¾§å¹¶åŠ ç²—æ˜¾ç¤º
const dialLabels = computed(() => {
  const minutes = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55]
  const r = 120 // å¤–ä¾§åŠå¾„ï¼šç•¥å¤§äºè¿›åº¦ç¯å¤–ç¼˜ï¼ˆ100 + 6 + marginï¼‰
  return minutes.map((m) => {
    const rad = (m * 6 - 90) * Math.PI / 180
    return {
      m,
      x: 128 + r * Math.cos(rad),
      y: 128 + r * Math.sin(rad),
    }
  })
})

function toggleMode() {
  // ä¸­æ–‡æ³¨é‡Šï¼šåˆ‡æ¢æ¨¡å¼ï¼Œæ­£è®¡æ—¶ä» 00:00 å¼€å§‹ï¼Œå€’è®¡æ—¶ä»è®¡åˆ’æ—¶é•¿å¼€å§‹
  mode.value = mode.value === 'countdown' ? 'countup' : 'countdown'
  const wasRunning = running.value
  stopInternal()
  remaining.value = mode.value === 'countdown' ? workM.value * 60 : 0
  store.updateTomato({ runningMode: mode.value, remainingSeconds: remaining.value })
  if (wasRunning) start()
}

function tick() {
  const now = Date.now()
  if (mode.value === 'countdown') {
    // åŸºäº endAtMs è®¡ç®—å‰©ä½™ï¼Œé¿å…é¡µé¢ä¸å¯è§æ—¶ä¸­æ–­
    const target = endAtMs.value ?? (startAtMs.value ? startAtMs.value + workM.value * 60 * 1000 : null)
    if (target == null) return
    remaining.value = Math.max(0, Math.round((target - now) / 1000))
    store.updateTomato({ remainingSeconds: remaining.value })
    if (remaining.value <= 0) {
      stopInternal()
      if (phase.value === 'work') {
        playEndCue().catch(() => {})
        emit('complete', workM.value * 60)
        phase.value = 'break'
        remaining.value = breakM.value * 60
      } else {
        phase.value = 'work'
        remaining.value = workM.value * 60
      }
    }
  } else {
    // æ­£è®¡æ—¶ï¼šåŸºäº startAtMs è®¡ç®—ç´¯è®¡ç§’æ•°
    if (!startAtMs.value) return
    remaining.value = Math.max(0, Math.round((now - startAtMs.value) / 1000))
    store.updateTomato({ remainingSeconds: remaining.value })
    if (remaining.value >= workM.value * 60) {
      stopInternal()
      emit('complete', remaining.value)
    }
  }
}

function start() {
  if (running.value) return
  running.value = true
  started.value = true
  // æ­£è®¡æ—¶ä» 00:00 å¼€å§‹
  if (mode.value === 'countup') remaining.value = 0
  // ä¸­æ–‡æ³¨é‡Šï¼šè®°å½•å¢™é’Ÿæ—¶é—´æˆ³ï¼Œç¡®ä¿é”å±åç»§ç»­è®¡æ—¶
  const now = Date.now()
  if (mode.value === 'countdown') {
    startAtMs.value = now
    endAtMs.value = now + remaining.value * 1000
  } else {
    startAtMs.value = now
    endAtMs.value = null
  }
  store.updateTomato({ running: true, runningMode: mode.value, durationMinutes: workM.value, remainingSeconds: remaining.value, currentTaskId: props.taskId ?? null, startAtMs: startAtMs.value, endAtMs: endAtMs.value })
  if (!timer) timer = setInterval(tick, 1000)
  // ä¸­æ–‡æ³¨é‡Šï¼šå¼€å§‹åå°è¯•ç”³è¯·å¸¸äº®ï¼ˆç§»åŠ¨ç«¯ï¼‰
  if (store.tomato.keepAwakeEnabled) {
    requestWakeLock().catch(() => {})
  }
}
function pause() {
  running.value = false
  if (timer) {
    clearInterval(timer)
    timer = null
  }
  // ä¸­æ–‡æ³¨é‡Šï¼šæš‚åœæ—¶ä¿ç•™å½“å‰ remainingSecondsï¼Œå¹¶æ¸…ç©ºæ—¶é—´æˆ³
  startAtMs.value = null
  endAtMs.value = null
  store.updateTomato({ running: false, startAtMs: null, endAtMs: null, runningMode: null })
  // ä¸­æ–‡æ³¨é‡Šï¼šæš‚åœæ—¶é‡Šæ”¾å¸¸äº®
  releaseWakeLock().catch(() => {})
}
function togglePauseResume() {
  if (!started.value) return
  if (running.value) {
    pause()
  } else {
    running.value = true
    const now = Date.now()
    if (mode.value === 'countdown') {
      endAtMs.value = now + remaining.value * 1000
      startAtMs.value = now
    } else {
      // æ­£è®¡æ—¶æ¢å¤ï¼šä¿æŒå·²ç”¨ç§’æ•°çš„è¿ç»­æ€§
      startAtMs.value = now - remaining.value * 1000
      endAtMs.value = null
    }
    store.updateTomato({ running: true, startAtMs: startAtMs.value, endAtMs: endAtMs.value })
    if (!timer) timer = setInterval(tick, 1000)
  }
}
// ä¸­æ–‡æ³¨é‡Šï¼šä¸»æŒ‰é’®åŠ¨ä½œï¼ˆå¼€å§‹/ç»§ç»­ï¼‰ï¼šæœªå¼€å§‹æ‰§è¡Œ startï¼Œå·²å¼€å§‹ä½†æš‚åœæ‰§è¡Œæ¢å¤
// ä¸»æŒ‰é’®é€»è¾‘ç”±å¤§åœ†æŒ‰é’®äº‹ä»¶ç»Ÿä¸€å¤„ç†
function reset() {
  pause()
  phase.value = 'work'
  remaining.value = workM.value * 60
  startAtMs.value = null
  endAtMs.value = null
  store.updateTomato({ remainingSeconds: remaining.value, startAtMs: null, endAtMs: null })
}
function complete() {
  // ä¸­æ–‡æ³¨é‡Šï¼šæ‰‹åŠ¨å®Œæˆï¼Œè§¦å‘ä¸ŠæŠ¥ï¼ˆæ­£è®¡æ—¶ç§’æ•° / å€’è®¡æ—¶æ¢ç®—ç§’æ•°ï¼‰
  const usedSeconds = mode.value === 'countdown' ? Math.max(0, workM.value * 60 - remaining.value) : remaining.value
  stopInternal()
  emit('complete', usedSeconds)
}
function stopInternal() {
  running.value = false
  if (timer) {
    clearInterval(timer)
    timer = null
  }
  startAtMs.value = null
  endAtMs.value = null
  store.updateTomato({ running: false, startAtMs: null, endAtMs: null, runningMode: null })
  // ä¸­æ–‡æ³¨é‡Šï¼šåœæ­¢æ—¶é‡Šæ”¾å¸¸äº®
  releaseWakeLock().catch(() => {})
}
// æ—¶é•¿è°ƒæ•´ç”±é¡µé¢èœå•å¤„ç†
// ä¸­æ–‡æ³¨é‡Šï¼šå…³é—­æŒ‰é’®å·²ç§»é™¤ï¼Œä½¿ç”¨å¯¹è¯æ¡†å³ä¸Šè§’é»˜è®¤å…³é—­æ§ä»¶

watch(phase, () => {
  // ä¸­æ–‡æ³¨é‡Šï¼šåˆ‡æ¢é˜¶æ®µæ—¶é‡ç½®è¿è¡ŒçŠ¶æ€ï¼Œé¿å…è‡ªåŠ¨ç»§ç»­
  pause()
})

watch(workM, (m) => {
  if (running.value) return
  const sec = (mode.value === 'countdown' ? m * 60 : 0)
  remaining.value = sec
  store.updateTomato({ durationMinutes: m, remainingSeconds: sec })
})

onUnmounted(() => {
  if (timer) clearInterval(timer)
})
// ä¸­æ–‡æ³¨é‡Šï¼šå¦‚æœè¿›å…¥é¡µé¢æ—¶ç•ªèŒ„é’Ÿä»åœ¨è¿è¡Œï¼ˆæ¥è‡ªæ‚¬æµ®çƒï¼‰ï¼Œè‡ªåŠ¨ç»§ç»­è®¡æ—¶ï¼›åŒæ—¶ç›‘å¬å¯è§æ€§å˜åŒ–ä»¥åˆ·æ–°ä¸€æ¬¡
onMounted(() => {
  if (store.tomato.running) {
    running.value = true
    started.value = true
    startAtMs.value = store.tomato.startAtMs ?? startAtMs.value
    endAtMs.value = store.tomato.endAtMs ?? endAtMs.value
    if (!timer) timer = setInterval(tick, 1000)
  }
  const onVis = () => {
    if (document.visibilityState === 'visible' && running.value) tick()
    // ä¸­æ–‡æ³¨é‡Šï¼šé¡µé¢é‡æ–°å¯è§ä¸”åœ¨è®¡æ—¶ï¼Œåˆ™å°è¯•é‡æ–°ç”³è¯·å¸¸äº®
    if (document.visibilityState === 'visible' && running.value && store.tomato.keepAwakeEnabled) {
      requestWakeLock().catch(() => {})
    }
  }
  document.addEventListener('visibilitychange', onVis)
  ;(window as any).__tomato_vis__ = onVis
})
onUnmounted(() => {
  const onVis = (window as any).__tomato_vis__
  if (onVis) document.removeEventListener('visibilitychange', onVis)
  // ä¸­æ–‡æ³¨é‡Šï¼šç»„ä»¶å¸è½½æ—¶é‡Šæ”¾å¸¸äº®
  releaseWakeLock().catch(() => {})
})
// ä¸­æ–‡æ³¨é‡Šï¼šç›‘å¬â€œä¿æŒå¸¸äº®â€å¼€å…³å˜åŒ–ï¼›è¿è¡Œä¸­å¼€å¯åˆ™ç”³è¯·ï¼Œå…³é—­åˆ™é‡Šæ”¾
watch(() => store.tomato.keepAwakeEnabled, (enabled) => {
  if (!running.value) return
  if (enabled) requestWakeLock().catch(() => {})
  else releaseWakeLock().catch(() => {})
})
// ä¸­æ–‡æ³¨é‡Šï¼šå‘çˆ¶ç»„ä»¶æš´éœ²åœæ­¢/å¼€å§‹/æš‚åœæ–¹æ³•ï¼Œä¾¿äºé¡µé¢â€œè¿”å›â€æ—¶æ§åˆ¶è¡Œä¸º
defineExpose({ stop: stopInternal, start, pause, reset })
</script>

<style scoped>
/* ä¸­æ–‡æ³¨é‡Šï¼šä½¿ç”¨åŸºç¡€æ–‡æœ¬æ ·å¼ä¸æŒ‰é’®å¸ƒå±€ï¼Œè§†è§‰è½»é‡ */
/* ä¸­æ–‡æ³¨é‡Šï¼šå¤œé—´ä¸»é¢˜ - ç»Ÿä¸€æ•°å­—è¾“å…¥æ§ä»¶çš„åº•çº¹ä¸æ–‡å­—é¢œè‰²ï¼Œä¸æŒ‰é’®é£æ ¼ä¸€è‡´ */
:deep(.el-input__wrapper) {
  background-color: #3a3a38 !important; /* rgb(58, 58, 56) */
  color: #B8CEE8 !important;
  box-shadow: 0 0 0 1px #4a4a48 inset !important; /* Element Plus ä½¿ç”¨ box-shadow æ¨¡æ‹Ÿè¾¹æ¡† */
}
:deep(.el-input__inner) {
  color: #B8CEE8 !important;
}
:deep(.el-input-number__decrease),
:deep(.el-input-number__increase) {
  color: #B8CEE8 !important;
  background-color: #3a3a38 !important;
  border-color: #4a4a48 !important;
}
:deep(.el-input-number__decrease:hover),
:deep(.el-input-number__increase:hover) {
  background-color: #3a3a38 !important;
}
</style>

