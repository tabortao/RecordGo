<template>
  <!-- ä¸­æ–‡æ³¨é‡Šï¼šç•ªèŒ„é’Ÿç»„ä»¶ï¼ˆå¢å¼ºç‰ˆï¼‰ï¼Œæ”¯æŒå€’è®¡æ—¶/æ­£è®¡æ—¶ã€é¢„è®¾ä¸è‡ªå®šä¹‰ã€å¼€å§‹/æš‚åœ/ç»§ç»­/å®Œæˆ -->
  <!-- ä¸­æ–‡æ³¨é‡Šï¼šå®¹å™¨æ”¹ä¸ºå……æ»¡è§†å£é«˜åº¦ï¼Œåº•éƒ¨åŒºåŸŸæ›´è´´è¿‘é¡µé¢åº•éƒ¨ -->
  <div class="relative p-4 flex flex-col justify-between">

    <!-- ä¸­æ–‡æ³¨é‡Šï¼šç§»é™¤ç»„ä»¶å†…éƒ¨æ ‡é¢˜ï¼Œé¿å…ä¸å¼¹çª—æ ‡é¢˜é‡å¤æ˜¾ç¤º -->

    <!-- ä¸­æ–‡æ³¨é‡Šï¼šæ—¶é—´å±…ä¸­ï¼Œå³ä¾§æä¾›æ¨¡å¼åˆ‡æ¢å›¾æ ‡ï¼›å¤‡æ³¨åœ¨æ—¶é—´ä¸‹æ–¹æ˜¾ç¤ºä¸ºç°è‰²å°å­— -->
    <!-- ä¸­æ–‡æ³¨é‡Šï¼šå¤œé—´ä¸»é¢˜ - æ—¶é—´ä¸å›¾æ ‡é¢œè‰²è°ƒæ•´ä¸ºæµ…è‰²ï¼ˆ#B8CEE8ï¼‰ï¼Œä½¿å¯¹æ¯”æ¸…æ™° -->
    <!-- ä¸­æ–‡æ³¨é‡Šï¼šä¸­éƒ¨åŒºåŸŸä½¿ç”¨ flex-1 å±…ä¸­ï¼Œè®©æ—¶é—´æ˜¾ç¤ºä½äºé¡¶éƒ¨ä¸åº•éƒ¨ä¹‹é—´çš„æ­£ä¸­ -->
    <div class="flex-1 flex flex-col items-center justify-center gap-3 pt-16 pb-32">
      <!-- ä¸­æ–‡æ³¨é‡Šï¼šè¡¨ç›˜æ ·å¼ + æ•°å­—æ—¶é—´ï¼šæµ…æ©™è‰²è¿›åº¦åœˆåœ¨å€’è®¡æ—¶æ¨¡å¼ä¸‹é€æ¸å‡å°‘ -->
      <div class="relative w-64 h-64">
        <svg width="256" height="256" viewBox="0 0 256 256">
          <!-- èƒŒæ™¯è½¨é“ -->
          <circle cx="128" cy="128" r="100" stroke="#4a4a48" stroke-width="16" fill="none" />
          <!-- é’Ÿè¡¨åˆ»åº¦ï¼š60 ä¸ªåˆ»åº¦ï¼Œ5 çš„å€æ•°åŠ ç²—åŠ é•¿ -->
          <g stroke="#B8CEE8" opacity="0.7">
            <template v-for="i in 60" :key="i">
              <line
                x1="128"
                y1="28"
                x2="128"
                :y2="((i-1) % 5 === 0) ? 44 : 36"
                :stroke-width="((i-1) % 5 === 0) ? 2.5 : 1.5"
                :transform="'rotate(' + ((i-1) * 6) + ' 128 128)'"
              />
            </template>
          </g>
          <!-- è¿›åº¦å¼§çº¿ï¼šå€’è®¡æ—¶å‰©ä½™æ¯”ä¾‹ï¼Œèµ·ç‚¹åœ¨ä¸Šæ–¹ï¼ˆ-90Â°æ—‹è½¬ï¼‰ -->
          <circle
            cx="128" cy="128" r="100"
            stroke="#F4A261" stroke-width="16" fill="none" stroke-linecap="butt"
            :style="{ transition: 'stroke-dashoffset .3s linear' }"
            :stroke-dasharray="circumference"
            :stroke-dashoffset="dashOffset"
            transform="rotate(-90 128 128)"
          />
          <!-- è¿›åº¦ç¯åˆ†é’Ÿåˆ†å‰²çº¿ï¼ˆç™½è‰²ï¼‰ï¼šæ¯ 1 åˆ†é’Ÿä¸€æ¡ï¼Œè¦†ç›–åœ¨è¿›åº¦ç¯ä¹‹ä¸Šï¼Œä½¿æ©™è‰²ç¯å‘ˆé—´æ–­ -->
          <g stroke="#FFFFFF" opacity="0.85">
            <template v-for="i in 60" :key="'sep-'+i">
              <line
                x1="128"
                y1="20"
                x2="128"
                y2="36"
                stroke-width="3"
                :transform="'rotate(' + ((i-1) * 6) + ' 128 128)'"
              />
            </template>
          </g>
          <!-- æ•°å­—åˆ»åº¦ï¼ˆ0ã€5ã€10...55ï¼‰ -->
          <g fill="#B8CEE8" font-size="12" opacity="0.95" font-family="monospace" font-weight="700">
            <template v-for="lbl in dialLabels" :key="lbl.m">
              <text :x="lbl.x" :y="lbl.y" text-anchor="middle" dominant-baseline="middle">{{ lbl.m }}</text>
            </template>
          </g>
        </svg>
        <!-- æ•°å­—æ—¶é—´ç½®äºè¡¨ç›˜ä¸­å¿ƒ -->
        <!-- ä¸­æ–‡æ³¨é‡Šï¼šä¸­å¿ƒæ—¶é—´åŒºåŸŸæ”¹ä¸ºä¸Šä¸‹ç»“æ„ï¼›ä¸Šæ–¹ç¬‘è„¸ã€ä¸‹æ–¹çº¢è‰²ç•ªèŒ„å›¾æ ‡ -->
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="flex flex-col items-center justify-center">
            <div class="text-xl select-none" :style="{ color: '#B8CEE8' }">ğŸ˜Š</div>
            <div class="text-6xl font-mono" :style="{ color: '#B8CEE8' }">{{ mm }}:{{ ss }}</div>
            <img src="@/assets/tomato.png" alt="ç•ªèŒ„" class="w-6 h-6 mt-2 select-none" />
          </div>
        </div>
      </div>
      <!-- æ¨¡å¼åˆ‡æ¢å›¾æ ‡ç½®äºæ—¶é—´ä¸‹æ–¹ï¼Œé¿å…ä¸ä¸­å¿ƒé‡å  -->
      <div>
        <el-icon
          class="cursor-pointer"
          :title="mode==='countdown' ? 'åˆ‡æ¢ä¸ºæ­£è®¡æ—¶' : 'åˆ‡æ¢ä¸ºå€’è®¡æ—¶'"
          :style="{ color: '#B8CEE8' }"
          @click="toggleMode"
        >
          <RefreshRight />
        </el-icon>
      </div>
      <div class="text-center text-xs" :style="{ color: '#9aa8b8' }" v-if="props.taskRemark">å¤‡æ³¨ï¼š{{ props.taskRemark }}</div>
      <!-- ä¸­æ–‡æ³¨é‡Šï¼šç§»é™¤é¢„è®¡æ—¶é•¿çš„å°å­—æç¤ºï¼Œç•Œé¢æ›´ç®€æ´ -->
    </div>

    <!-- ä¸­æ–‡æ³¨é‡Šï¼šåº•éƒ¨åŒºåŸŸ - åŒ…å«æ—¶é—´é¢„è®¾/è‡ªå®šä¹‰ä¸æ§åˆ¶æŒ‰é’®ï¼Œæ›´è´´è¿‘é¡µé¢åº•éƒ¨ -->
    <div class="fixed bottom-4 left-0 right-0 space-y-3" data-bottom="tomato-controls">
      <!-- ä¸­æ–‡æ³¨é‡Šï¼šå€’è®¡æ—¶æ¨¡å¼ä¸‹æ˜¾ç¤ºé¢„è®¾ä¸è‡ªå®šä¹‰ï¼›æ­£è®¡æ—¶ä¸æ˜¾ç¤ºè¿™äº› -->
      <div class="flex items-center justify-center gap-3" v-if="mode==='countdown'">
      <div class="flex items-center gap-2">
        <el-tag class="cursor-pointer" @click="setDuration(10)" :style="nightTagStyle">10åˆ†é’Ÿ</el-tag>
        <el-tag class="cursor-pointer" @click="setDuration(20)" :style="nightTagStyle">20åˆ†é’Ÿ</el-tag>
      </div>
      <!-- ä¸­æ–‡æ³¨é‡Šï¼šæ­¥è¿›æ”¹ä¸º5åˆ†é’Ÿï¼Œç‚¹å‡» + / - æŒ‰5åˆ†é’Ÿå¢å‡ -->
      <el-input-number v-model="customMinutes" :min="1" :max="240" :step="5" />
      <el-button size="small" @click="applyCustom" :style="nightBtnStyle">åº”ç”¨</el-button>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="flex justify-center gap-2 mt-2">
      <el-button @click="start" :disabled="running" :style="nightBtnStyle">å¼€å§‹</el-button>
      <el-button @click="togglePauseResume" :disabled="!started" :style="nightBtnStyle">{{ running ? 'æš‚åœ' : 'ç»§ç»­' }}</el-button>
      <el-button @click="reset" :style="nightBtnStyle">é‡ç½®</el-button>
      <el-button @click="complete" :style="nightBtnStyle">å®Œæˆ</el-button>
    </div>

    </div>
  </div>
</template>

<script setup lang="ts">
// ä¸­æ–‡æ³¨é‡Šï¼šæ¥æ”¶ä»»åŠ¡åä¸å¤‡æ³¨ + å·¥ä½œ/ä¼‘æ¯åˆ†é’Ÿæ•°ï¼ˆåˆå¹¶å®šä¹‰ï¼‰
// ä¸­æ–‡æ³¨é‡Šï¼šç•ªèŒ„é’Ÿé€»è¾‘ï¼Œå·¥ä½œä¸ä¼‘æ¯ä¸¤ä¸ªé˜¶æ®µï¼Œå€’è®¡æ—¶ç»“æŸååˆ‡æ¢é˜¶æ®µå¹¶åœ¨å·¥ä½œç»“æŸæ—¶è§¦å‘ complete äº‹ä»¶
import { computed, onUnmounted, ref, watch } from 'vue'
import { useAppState } from '@/stores/appState'
import { RefreshRight } from '@element-plus/icons-vue'

const props = defineProps<{ workMinutes?: number; breakMinutes?: number; taskName?: string; taskRemark?: string }>()
const emit = defineEmits<{ (e: 'complete', seconds: number): void }>()
const store = useAppState()

const workM = computed(() => props.workMinutes ?? store.tomato.durationMinutes ?? 20)
const breakM = computed(() => props.breakMinutes ?? 5)

type Phase = 'work' | 'break'
const phase = ref<Phase>('work')
const mode = ref<'countdown' | 'countup'>(store.tomato.mode)
// ä¸­æ–‡æ³¨é‡Šï¼šå¤œé—´ä¸»é¢˜æŒ‰é’®ä¸ Tag æ ·å¼ï¼ˆä¸æ·±è‰²èƒŒæ™¯åè°ƒï¼‰
const nightBtnStyle = { backgroundColor: '#3a3a38', color: '#B8CEE8', borderColor: '#4a4a48' }
const nightTagStyle = { backgroundColor: '#3a3a38', color: '#B8CEE8', borderColor: '#4a4a48' }
const running = ref(store.tomato.running)
const remaining = ref(store.tomato.remainingSeconds || (mode.value === 'countdown' ? workM.value * 60 : 0))
const started = ref(false)
const customMinutes = ref(workM.value)
let timer: any = null

// ä¸­æ–‡æ³¨é‡Šï¼šç§»é™¤æœªä½¿ç”¨çš„æ–‡æœ¬è®¡ç®—ï¼Œé¿å…æ— ç”¨è­¦å‘Š
const mm = computed(() => String(Math.floor(remaining.value / 60)).padStart(2, '0'))
const ss = computed(() => String(remaining.value % 60).padStart(2, '0'))
// ä¸­æ–‡æ³¨é‡Šï¼šè¡¨ç›˜è¿›åº¦æŒ‰ 60 åˆ†é’Ÿæ»¡åœˆæ˜ å°„ã€‚å€’è®¡æ—¶æ˜¾ç¤ºå‰©ä½™ä¸ 60 çš„æ¯”ä¾‹ï¼Œæ­£è®¡æ—¶æ˜¾ç¤ºå‰©ä½™ï¼ˆè®¡åˆ’-å·²ç”¨ï¼‰ä¸ 60 çš„æ¯”ä¾‹ã€‚
const dialRatio = computed(() => {
  if (mode.value === 'countdown') {
    // å€’è®¡æ—¶ï¼šæ˜¾ç¤ºå‰©ä½™ç›¸å¯¹ 60 åˆ†é’Ÿçš„æ¯”ä¾‹ï¼ˆé€æ­¥å‡å°‘ï¼‰
    return Math.min(1, Math.max(0, remaining.value / 3600))
  }
  // æ­£è®¡æ—¶ï¼šæ˜¾ç¤ºå·²ç”¨æ—¶é—´ç›¸å¯¹ 60 åˆ†é’Ÿçš„æ¯”ä¾‹ï¼ˆä» 0 é€æ­¥å¢åŠ ï¼‰
  return Math.min(1, Math.max(0, remaining.value / 3600))
})
const circumference = 2 * Math.PI * 100
const dashOffset = computed(() => circumference * (1 - dialRatio.value))
// ä¸­æ–‡æ³¨é‡Šï¼šæ•°å­—åˆ»åº¦ä½ç½®ï¼ˆ0ã€5ã€10...55ï¼‰ï¼Œæ”¾åˆ°è¡¨ç›˜å¤–ä¾§å¹¶åŠ ç²—æ˜¾ç¤º
const dialLabels = computed(() => {
  const minutes = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55]
  const r = 120 // å¤–ä¾§åŠå¾„ï¼šç•¥å¤§äºè¿›åº¦ç¯å¤–ç¼˜ï¼ˆ100 + 6 + marginï¼‰
  return minutes.map((m) => {
    const rad = (m * 6 - 90) * Math.PI / 180
    return {
      m,
      x: 128 + r * Math.cos(rad),
      y: 128 + r * Math.sin(rad),
    }
  })
})

function toggleMode() {
  // ä¸­æ–‡æ³¨é‡Šï¼šåˆ‡æ¢æ¨¡å¼ï¼Œæ­£è®¡æ—¶ä» 00:00 å¼€å§‹ï¼Œå€’è®¡æ—¶ä»è®¡åˆ’æ—¶é•¿å¼€å§‹
  mode.value = mode.value === 'countdown' ? 'countup' : 'countdown'
  const wasRunning = running.value
  stopInternal()
  remaining.value = mode.value === 'countdown' ? workM.value * 60 : 0
  store.updateTomato({ mode: mode.value, remainingSeconds: remaining.value })
  if (wasRunning) start()
}

function tick() {
  if (mode.value === 'countdown') {
    if (remaining.value > 0) {
      remaining.value -= 1
      store.updateTomato({ remainingSeconds: remaining.value })
      return
    }
    stopInternal()
    if (phase.value === 'work') {
      // ä¸­æ–‡æ³¨é‡Šï¼šå·¥ä½œé˜¶æ®µå€’è®¡æ—¶ç»“æŸï¼ŒæŒ‰è®¡åˆ’æ—¶é•¿ï¼ˆç§’ï¼‰ä¸ŠæŠ¥
      emit('complete', workM.value * 60)
      phase.value = 'break'
      remaining.value = breakM.value * 60
    } else {
      phase.value = 'work'
      remaining.value = workM.value * 60
    }
  } else {
    // æ­£è®¡æ—¶ï¼šå‘ä¸Šç´¯è®¡ï¼Œåˆ°è¾¾ç›®æ ‡åˆ†é’Ÿè§¦å‘å®Œæˆ
    remaining.value += 1
    store.updateTomato({ remainingSeconds: remaining.value })
    if (remaining.value >= workM.value * 60) {
      stopInternal()
      // ä¸­æ–‡æ³¨é‡Šï¼šæ­£è®¡æ—¶å®Œæˆæ—¶æŒ‰ç´¯è®¡ç§’æ•°ä¸ŠæŠ¥
      emit('complete', remaining.value)
    }
  }
}

function start() {
  if (running.value) return
  running.value = true
  started.value = true
  // æ­£è®¡æ—¶ä» 00:00 å¼€å§‹
  if (mode.value === 'countup') remaining.value = 0
  store.updateTomato({ running: true, mode: mode.value, durationMinutes: workM.value, remainingSeconds: remaining.value })
  if (!timer) timer = setInterval(tick, 1000)
}
function pause() {
  running.value = false
  if (timer) {
    clearInterval(timer)
    timer = null
  }
  store.updateTomato({ running: false })
}
function togglePauseResume() {
  if (!started.value) return
  if (running.value) {
    pause()
  } else {
    running.value = true
    if (!timer) timer = setInterval(tick, 1000)
    store.updateTomato({ running: true })
  }
}
function reset() {
  pause()
  phase.value = 'work'
  remaining.value = workM.value * 60
  store.updateTomato({ remainingSeconds: remaining.value })
}
function complete() {
  // ä¸­æ–‡æ³¨é‡Šï¼šæ‰‹åŠ¨å®Œæˆï¼Œè§¦å‘ä¸ŠæŠ¥ï¼ˆæ­£è®¡æ—¶ç§’æ•° / å€’è®¡æ—¶æ¢ç®—ç§’æ•°ï¼‰
  const usedSeconds = mode.value === 'countdown' ? Math.max(0, workM.value * 60 - remaining.value) : remaining.value
  stopInternal()
  emit('complete', usedSeconds)
}
function stopInternal() {
  running.value = false
  if (timer) {
    clearInterval(timer)
    timer = null
  }
  store.updateTomato({ running: false })
}
function setDuration(min: number) {
  customMinutes.value = min
  applyCustom()
}
function applyCustom() {
  // ä¸­æ–‡æ³¨é‡Šï¼šæ›´æ–°å·¥ä½œæ—¶é•¿ä¸å‰©ä½™æ—¶é—´
  const m = customMinutes.value
  const wasRunning = running.value
  stopInternal()
  remaining.value = mode.value === 'countdown' ? m * 60 : 0
  store.updateTomato({ durationMinutes: m, remainingSeconds: remaining.value })
  if (wasRunning) start()
}
// ä¸­æ–‡æ³¨é‡Šï¼šå…³é—­æŒ‰é’®å·²ç§»é™¤ï¼Œä½¿ç”¨å¯¹è¯æ¡†å³ä¸Šè§’é»˜è®¤å…³é—­æ§ä»¶

watch(phase, () => {
  // ä¸­æ–‡æ³¨é‡Šï¼šåˆ‡æ¢é˜¶æ®µæ—¶é‡ç½®è¿è¡ŒçŠ¶æ€ï¼Œé¿å…è‡ªåŠ¨ç»§ç»­
  pause()
})

onUnmounted(() => {
  if (timer) clearInterval(timer)
})
</script>

<style scoped>
/* ä¸­æ–‡æ³¨é‡Šï¼šä½¿ç”¨åŸºç¡€æ–‡æœ¬æ ·å¼ä¸æŒ‰é’®å¸ƒå±€ï¼Œè§†è§‰è½»é‡ */
/* ä¸­æ–‡æ³¨é‡Šï¼šå¤œé—´ä¸»é¢˜ - ç»Ÿä¸€æ•°å­—è¾“å…¥æ§ä»¶çš„åº•çº¹ä¸æ–‡å­—é¢œè‰²ï¼Œä¸æŒ‰é’®é£æ ¼ä¸€è‡´ */
:deep(.el-input__wrapper) {
  background-color: #3a3a38 !important; /* rgb(58, 58, 56) */
  color: #B8CEE8 !important;
  box-shadow: 0 0 0 1px #4a4a48 inset !important; /* Element Plus ä½¿ç”¨ box-shadow æ¨¡æ‹Ÿè¾¹æ¡† */
}
:deep(.el-input__inner) {
  color: #B8CEE8 !important;
}
:deep(.el-input-number__decrease),
:deep(.el-input-number__increase) {
  color: #B8CEE8 !important;
  background-color: #3a3a38 !important;
  border-color: #4a4a48 !important;
}
:deep(.el-input-number__decrease:hover),
:deep(.el-input-number__increase:hover) {
  background-color: #3a3a38 !important;
}
</style>

