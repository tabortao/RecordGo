# 任务与积分小程序需求文档

## 1. 项目概述

本小程序是一个面向学生的任务与积分管理工具，旨在通过简洁有趣的界面和激励机制，帮助学生培养良好的学习习惯和时间管理能力。系统采用前后端分离架构，前端使用 Vue 3 + Vite + Element Plus + Pinia，后端使用Gin框架，数据库使用SQLite。

## 2. 目标与背景

### 2.1 目标用户

- 学生（主要用户）
- 家长或老师（协助配置和监督）

### 2.2 产品目标

通过简洁有趣的打卡界面和番茄钟机制，培养学生的时间管理习惯，记录每日任务完成情况，并通过积分激励机制增强学习动力。

### 2.3 非功能要求

- 界面友好、低学习成本，设计风格能够吸引学生使用
- 支持离线使用（PWA 功能）
- 响应式设计，支持在平板或手机等小屏浏览器访问
- 支持 Docker 部署

## 3. 系统架构

### 3.1 前端架构

- 技术栈：vue3、vue-router（路由）、pinia（状态管理）、element-plus（UI组件库）

```yml
框架:
  - Vue 3: Composition API + Script Setup
  - TypeScript: 类型安全
构建工具:
  - Vite: 快速构建工具
  - unplugin-auto-import: 自动导入API
  - unplugin-vue-components: 自动导入组件
状态管理:
  - Pinia: 轻量级状态管理
UI组件库:
  - Element Plus: 企业级UI组件
路由:
  - Vue Router 4: 路由管理

HTTP客户端:
  - Axios: HTTP请求库
  - Axios拦截器: 请求/响应处理
工具库:
  - VueUse: 组合式工具库
  - Day.js: 日期处理
  - Lodash-es: 工具函数
样式方案:
  - Tailwind CSS: 实用优先CSS框架
```
- 页面结构：采用底部导航栏设计，包含三个主要界面
  - 任务
  - 心愿
  - 我的
- 所有页面需实现滚动调节功能和自适应高度机制
- 所有上传图片需压缩转换为webp格式存储并调用

### 3.2 后端架构

- 技术栈：

```yml
Web框架:
  - Gin: 高性能HTTP框架
数据库:
  - GORM: ORM库
  - SQLite: 开发环境数据库
配置管理:
  - Viper: 配置解析
  - 环境变量: 多环境配置
认证授权:
  - JWT: 用户认证
  - Casbin: 权限控制（可选）
日志系统:
  - Zap: 高性能结构化日志
其他工具:
  - Go Migrate: 数据库迁移
```

- API 设计：RESTful API
- 数据存储：用户数据、任务数据、积分数据、心愿数据等
- 文件存储：
  - 用户头像存储在 storage/uploads/images/avatars/{用户id} 文件夹
  - 任务图片存储在 storage/uploads/images/task_images/{用户id} 文件夹
  - 心愿图片存储在 storage/uploads/images/wish/{用户id} 文件夹
- 数据库文件路径：storage/database/recordgo.db
- 支持Docker部署，使用环境变量配置SECRET_KEY

## 4. 功能模块

### 4.1 用户管理系统

#### 4.1.1 注册登录功能

- 支持账号注册与登录
- 首次注册的账号为主账号，作为管理员
- 登录页面不显示底部导航栏

#### 4.1.2 子账号管理
- 在"我的"页面的账号管理功能区域下方，新增"子账号管理"按钮
- 管理员可创建和管理子账号，每个子账号独立管理作业和积分
- 每个子账号数据通过parent_id字段与主账号关联，子账号使用主账号的金币池，共享金币总量。系统在获取子账号信息时会自动同步父账号的金币数据
- 支持输入子账号的头像、昵称、用户名和密码，用户名需与数据库中已有用户名不重复
- 支持修改已建子账号的昵称、头像和权限
- 支持删除子账号
- 子账号和主账号操作记录需要显示一致，操作记录中增加"操作人"字段
- 子账号登录时，返回包含parent_id和权限信息的用户数据
- 权限通过permissions字段的JSON格式进行存储，如`{"view_only": false}`表示可编辑权限
- 子账号的UI权限控制包括：添加任务按钮的显示/隐藏、任务编辑功能的启用/禁用等
- 页面切换时会自动更新权限设置，确保权限正确应用

#### 4.1.3 权限管理

- 管理员可设置子账号操作权限，提供"仅查看"和"可编辑"两种权限选择
- "仅查看"权限：子账号登录后，禁用所有添加、编辑、删除和设置功能，只能浏览内容
  - "我的"页面中"子账号管理"、"编辑个人信息"、"清除数据"按钮需隐藏
  - "小心愿"页面"兑换"、"创建心愿"按钮为灰色，不可操作
  - 可查看"领取记录"
- "可编辑"权限：子账号拥有与主账号相同的操作权限，但禁止删除主账号
- 只有拥有相应权限的用户才能执行对应操作

#### 4.1.4 密码管理

- 支持设置和修改密码
- 用户未设置密码时，所有需要验证密码的操作可直接进行

### 4.2 任务界面

#### 4.2.1 页面顶部设计

- 显示用户头像和用户昵称，同行最右侧显示总金币（图标加数字显示）
- 日时长、任务数、日金币、完成率上方需要有对应图标
- 总金币上方图标为金钱相关图标

#### 4.2.2 数据统计展示

- 顶部显示一行数据统计："日时长"、"任务数"、"日金币"、"完成率"、"统计"（仅显示图标）
- 日时长：统计今日任务完成的总时间
- 任务数：统计今日总任务个数
- 日金币：统计每日获得的金币数，可设置为负数，表示惩罚
- 完成率：计算今日任务完成的百分比
- 总金币：统计当前账号总的金币个数
- 统计：多方位展示每天、每周、每月、全部的数据图表
- 统计数据会在页面切换和任务状态变更时自动更新
- 统计数据会临时缓存在前端，减少API调用次数
- 通过API获取实时数据并更新UI

#### 4.2.3 日期选择与周视图

- 显示当前周信息（如"2025 年 10 月第 41 周"），居中显示
- 右侧显示一个小圆圈包裹浅绿色背景的"本周"按钮，点击后返回到今日
- 支持通过左右箭头切换周视图
- 每周从周一开始显示，日期选择与周视图需根据界面大小自动调整
- 点击任意日期可切换到该日期的任务计划页面，任务标题实时更新为对应日期的任务标题
- 选中状态显示为整个日期区域选中
- 日期下方展示小圆点+该日任务数

#### 4.2.4 任务列表展示

- 今日任务放到"全部分类"的上方，其同一行右侧有全部、已完成、待完成筛选选项
- 按分类展示任务
- 提供"全部分类"、"语文"、"数学"等筛选选项
- 每个任务显示计划时长、实际耗时和奖励金币
- 任务时间和任务积分与任务描述放到同一行

#### 4.2.5 任务卡片

- 显示任务名称、描述、计划时长、实际耗时
- 显示任务状态（已完成、待完成、未完成）
- 提供操作菜单：编辑、番茄钟、删除按钮，按钮左侧需要有对应图标
- 点击任务卡片可展开/折叠更多详情
- 任务图片图标显示在预计完成时间左侧，点击可左右翻页查看上传的图片

#### 4.2.6 番茄钟功能
- 点击任务卡片菜单中的"番茄钟"按钮弹出番茄钟窗口
- 番茄钟页面右上角需要有个关闭按钮
- 番茄钟时间默认为任务的计划时间，可自定义设置，默认 20 分钟
- 提供开始、暂停/继续、完成按钮
- 支持倒计时和正计时两种模式，用户可随时切换
- 提供预设时间选项（10分钟、15分钟、20分钟、30分钟），并支持自定义时间输入
- 点击开始后，番茄钟可缩小为悬浮球显示倒计时
- 悬浮球显示位置：位于底部导航栏正中间位置上方
- 悬浮球显示蓝色透明背景，像装水容器一样随时间慢慢变满，支持水位填充动画，直观展示计时进度
- 当番茄钟正在倒计时时，点击悬浮番茄钟，番茄钟页面弹出并全屏显示
- 点击番茄钟页面旁边任意区域时，番茄钟页面缩小为悬浮球状态
- 完成后任务自动标记为已完成，更新实际完成时间
- 支持在“我的”页面设置中，设置"固定番茄钟页面"选项，勾选后番茄钟保持全屏显示，不会缩小为悬浮球
- 实现番茄钟状态持久化，刷新页面后能完整保留当前番茄钟状态，状态通过appState进行全局管理
- 番茄钟设置保存到UserSettings表中


### 4.3 心愿界面

#### 4.3.1 页面顶部设计

- 上方显示"「用户昵称」的心愿收集"

#### 4.3.2 心愿展示

- 显示可用金币数量，位于页面最左侧
- 展示默认内置的 6 个小心愿："看电视"、"零花钱"、"玩平板"、"玩手机"、"玩游戏"、"自由活动"
- 所有用户（包括管理员）都能看到这些心愿

#### 4.3.3 心愿属性

- 心愿图标：支持选择内置图片或自定义上传
- 默认内置6个心愿与 storage/images/honors 中图片名称一致
- 心愿图片上传到 storage/uploads/images/wish/{用户id} 文件夹
- 上传图片转换为webp格式存储比调用
- 心愿名称
- 心愿内容描述
- 兑换所需金币
- 兑换数量：可设置数字，存储在exchange_amount字段
- 兑换礼物的单位（如分钟、元、个等）
- 已兑换次数显示
- 图片命名格式：wish_用户ID_时间戳_uuid.扩展名
- 支持图片上传前预览，并处理加载失败的情况

#### 4.3.4 心愿管理

- 支持用户自定义添加新的心愿
- 支持编辑和删除自定义心愿，内置心愿也可编辑
- 编辑心愿图标默认隐藏，点击心愿后显示
- 创建心愿按钮与下方心愿保持适当间距
- 删除心愿时对应上传的心愿图标也删除

#### 4.3.5 兑换功能

- 支持用金币兑换心愿
- 点击"兑换"按钮时，弹出确认弹窗，显示兑换数量信息
- 用户点击确认按钮后，执行兑换操作
- 完成后显示兑换成功提示信息，包含"兑换成功 xxx"以及扣除的金币数量
- 兑换成功后更新金币数量和兑换次数

#### 4.3.6 领取记录

- "可用金币"同一行最右侧提供"领取记录"按钮
- 点击可查看小心愿兑换相关记录
- 子账号和主账号领取记录显示需一致

### 4.4 我的界面

#### 4.4.1 页面顶部设计

- 上方显示用户昵称、用户 ID 及用户头像
- 子账号显示父账号信息，主账号不显示

#### 4.4.2 个人信息

- 显示当前用户名
- 显示用户昵称，如未设置昵称，显示用户名
- 显示总番茄个数
- 显示总金币数
- 支持编辑个人信息，包括昵称、头像、修改密码、手机号等
- 用户可以选择Emoji头像或自定义上传头像
- 默认头像使用 storage/images/avatars/default.png
- 用户自定义头像存储在`storage/uploads/images/avatars/{用户id}`目录

#### 4.4.3 荣誉系统

- 按月显示获得的荣誉
- 提供 20 种荣誉种类，如"连续打卡 7 天"、"学习达人"、"阅读之星"等
- 默认荣誉名称与 storage/images/honors 中图片名称一致
- 显示荣誉获得次数，显示在荣誉卡的右上角
- 未获得的荣誉灰色显示
- 每次获得荣誉后，弹出庆祝效果告知用户

#### 4.4.4 荣誉墙展示

- 点击"我的荣誉"，弹出荣誉墙页面
- 页面无渐变色，右上角有关闭按钮
- 点击荣誉墙外侧区域，自动关闭页面
- 页面可滚动调节，高度自适应

#### 4.4.5 数据管理

- 数据导出功能：导出用户所有数据，包含金币、小心愿相关设置等
- 数据清除功能：清除用户所有数据，包含金币、示例数据等
- 操作记录查看：显示用户近一个月的操作历史，支持分页查询、时间范围过滤，主账号可查看子账号的操作记录

#### 4.4.6 操作记录

- 记录添加/删除/编辑任务、学科、用户等操作
- 记录番茄钟操作
- 记录心愿兑换操作
- 记录金币修改操作
- 记录数据清除操作
- 记录金币修改原因
- 操作记录保存近一个月，过期自动删除
- 操作记录页面右上角有关闭按钮
- 每页显示 10 条记录，支持自动翻页
- 页面可滚动，高度自适应

#### 4.4.7 系统设置

- 番茄钟设置：可勾选"固定番茄钟页面"选项
- 任务设置：可启用"未完成任务自动迁移"功能
- 学科设置：管理学科分类，支持添加、编辑、删除、拖拽排序
- 金币设置：查看和修改总金币数量，修改需给出原因并记录到操作日志

#### 4.4.8 关于页面

- 点击"关于"按钮，弹出模态窗口
- 显示软件图标（frontend/static/images/favicon/android-chrome-192x192.png）和名称"任务积分助手"
- 显示版本号（从JSON配置文件读取）
- 提供"关注小红书"按钮，点击跳转到指定小红书账号
- 提供"邮件联系"按钮，点击触发邮件客户端，收件人为terlun@foxmail.com

#### 4.4.9 退出登录

- 支持退出当前登录，点击后跳转到登录页面

### 4.5 任务管理

#### 4.5.1 任务属性

- 任务编号（系统自动生成）
- 任务图标（默认提供，支持选择或自定义上传）
- 任务名称
- 任务描述
- 任务积分（可为负数，表示惩罚）
- 任务分类（支持内置或自定义分类）
- 重复设置（无、每天、每个工作日、每周选择特定日期，支持多选）
- 开始日期和结束日期，默认开始日期为当天
- 任务状态（已完成、未完成）
- 备注信息
- 计划时长（默认 10 分钟）
- 实际耗时
- 任务图片：支持上传多张图片，JSON格式存储
- seriesId（循环任务系列 ID，用于关联同一任务系列的所有实例）
- 创建时间和更新时间

#### 4.5.2 任务添加与编辑

- 支持单个添加和批量添加两种方式
- 单个添加：显示常规任务表单
- 批量添加：支持输入作业文本，智能识别多个任务，可编辑后添加，识别规则包括学科标题识别、任务列表项识别等
- 支持一次性任务和循环任务
- 一次性任务：只能设置开始日期，可选择历史日期进行补打卡
- 循环任务：必须设置开始日期，可选设置结束日期
- 添加任务时默认计划时长为 10 分钟，默认奖励金币为 1 金币
- 编辑循环任务时，可选择"只更新未来实例"或"更新历史+未来所有实例"
- 任务图片上传前在前端进行压缩处理为webp，确保图片大小合理
- 上传的图片保存到服务器 storage/uploads/images/task_images/{用户id} 文件夹下
- 图片上传后可预览完整图片
- 批量添加API支持同时创建多个任务及其重复实例
- 循环任务支持根据重复设置自动生成未来日期的任务实例
- 批量添加时可以选择需要添加的任务，支持全选和反选
- 根据任务名称长度自动推断预计时间和积分
- 任务添加/编辑表单支持重复设置的互斥逻辑和动态样式更新
- 任务添加/编辑时有完善的表单验证机制，确保数据有效性

#### 4.5.3 任务删除

- 删除前提供确认提示，需自定义提示，不使用系统提示
- 支持删除单个任务或整个任务系列
- 删除任务时，总分数中对应删除获得的任务积分

#### 4.5.4 任务有效期

- 超过结束日期的任务自动隐藏
- 未到开始日期的任务不显示
- 可通过日历查看历史任务

#### 4.5.5 任务自动迁移

- 用户可启用"未完成任务自动迁移"功能
- 启用后，刷新页面时自动扫描所有未完成的历史任务
- 将未完成历史任务迁移到今天并标记为迁移任务
- 同时在历史任务中删除，避免重复迁移
- 迁移过程有日志记录
- 自动迁移设置保存到UserSettings表

### 4.6 任务分类系统

#### 4.6.1 内置分类

- 语文、数学、英语

#### 4.6.2 自定义分类

- 支持用户根据需要创建新的任务分类
- 支持设置分类的主题颜色
- 支持删除自定义分类
- 支持拖拽排序，对应添加任务时学科分类下拉菜单的显示顺序

## 5. 数据模型

### 5.1 用户表

- 用户 ID (primary key)
- 用户名 (unique)
- 密码（SHA256加密存储）
- 角色（admin/user）
- 权限设置（JSON格式存储，如{"view_only": false}）
- 总金币数
- 总番茄数
- 昵称
- 头像路径（默认default.svg）
- 手机号
- 创建时间
- 父账号ID (parent_id，外键关联user表自身)
- 关系定义：tasks, categories, wishes, logs, honors, subaccounts

### 5.2 任务表

- 任务 ID (primary key)
- 用户 ID (外键关联user表)
- seriesId（循环任务系列 ID）
- 任务名称
- 任务描述
- 任务图标
- 任务分类
- 计划时长（默认10分钟）
- 实际耗时（默认0）
- 任务积分（默认1，可以为负数）
- 重复设置（默认'无'，支持无、每天、每周、每月、自定义星期）
- 开始日期
- 结束日期
- 任务状态（默认'未完成'，实际实现中状态定义为：0-待完成，1-进行中，2-已完成）
- 创建时间
- 更新时间
- 备注
- 图片路径（JSON格式存储图片路径数组）

### 5.3 任务分类表

- 分类 ID
- 用户 ID
- 分类名称
- 分类颜色
- 是否内置
- 排序顺序

### 5.4 心愿表

- 心愿 ID
- 用户 ID
- 心愿名称
- 心愿内容
- 心愿图标
- 兑换所需金币
- 兑换数量
- 兑换单位
- 已兑换次数
- 是否内置

### 5.5 操作记录表

- 记录 ID
- 用户 ID
- 操作类型
- 操作内容
- 操作时间
- 操作结果
- 操作人（用户昵称）
- 修改原因（针对金币修改等操作）

### 5.6 荣誉表

- 荣誉 ID
- 荣誉名称
- 荣誉描述
- 触发条件
- 图标路径

### 5.7 用户荣誉表

- 记录 ID (primary key)
- 用户 ID (外键关联user表)
- 荣誉 ID (外键关联honor表)
- 获得时间
- 获得次数（默认1）

### 5.8 用户设置表

- 设置 ID (primary key)
- 用户 ID (外键关联user表，唯一)
- fixed_tomato_page（是否固定番茄钟页面，默认false）
- task_auto_sort（是否开启任务自动排序，默认false）
- 创建时间
- 更新时间
- 关系定义：一对一关联user表
- tomato_settings：番茄钟设置（JSON格式，包含默认时长、休息时长、计时模式偏好、固定页面模式设置等）
- task_migration_settings：任务迁移设置（JSON格式，控制任务自动迁移的时间和规则）

## 6. 界面设计

### 6.1 设计风格

- 整体采用绿色作为主题色
- 卡片式布局，简洁明了
- 图标和 UI 元素设计符合学生审美
- 界面布局紧凑
- "作业打卡"、"小心愿"、"我的"页面分别有不同的背景颜色
- 任务卡片显示任务名称、描述、计划时长、实际耗时
- 任务状态（已完成、未完成）

### 6.2 底部导航栏

- 包含三个主要入口："作业打卡"、"小心愿"、"我的"
- 当前页面导航项高亮显示
- 高度适中，与常见手机 App 底部导航栏高度一致

### 6.3 交互动效

- 浮动添加按钮动画效果
- 任务卡片展开/折叠动画
- 番茄钟状态切换动画
- 金币数量变化动画
- 荣誉获得庆祝效果

## 7. 安全与性能

### 7.1 数据安全

- 用户密码加密存储
- 敏感操作需密码验证
- 数据定期备份

### 7.2 性能优化

- 支持离线使用（PWA）
- 前端数据缓存
- 页面懒加载
- 图片上传前压缩处理
- 支持 Docker 部署优化
- 数据库创建索引提高查询性能
- 任务查询支持分页
- 子账号数据查询自动关联主账号数据
- 前端实现了本地存储缓存，减少API调用次数
- 用户信息优先从本地缓存读取，需要时再从API获取
- 合理使用内存缓存，避免重复计算
- 对于操作记录、兑换记录等可能返回大量数据的查询，采用分页机制
- 为API调用添加超时机制，避免长时间等待
- 部分关键API实现了错误重试机制，提高系统稳定性