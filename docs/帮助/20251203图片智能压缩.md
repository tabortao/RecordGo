# 图片智能压缩          
**目标与方案**
- 将前端图片压缩统一切换为 `browser-image-compression`，按需转换为 `webp`，在上传前进行“智能压缩”与格式统一。
- 保持现有上传接口不变（任务图片、心愿图标、备注附件、头像、成长记录图片/音频），最小化改动、复用已有逻辑。
- 统一前端压缩入口为 `utils/image.prepareUpload`，所有图片上传路径与后端约定保持一致。

**已完成**
- 替换图片压缩库为 `browser-image-compression`，统一压缩工具函数。
- 成长记录页面移除散落的 `image-conversion` 使用，改为统一 `prepareUpload`。
- 更新依赖：新增 `browser-image-compression`，移除 `image-conversion`；已执行依赖安装与类型检查。

**核心改动**
- 统一压缩工具
  - 将工具函数改为使用 `browser-image-compression`，根据原文件大小动态计算目标体积与质量，强制输出 `image/webp`，并保留“接近原始体积时优先原图”的安全策略。
  - 代码位置：`frontend/src/utils/image.ts:3–23,31–45`
    - `toWebp(file, quality)`：动态目标体积 `maxSizeMB`（约 60–220KB 区间），`maxWidthOrHeight=1920`，`fileType='image/webp'`，多线程压缩。
    - `prepareUpload(file, quality)`：统一入口，默认 `quality=0.8`，近似体积不降时回退原文件。
- 统一调用入口
  - 任务图片、心愿图标、备注图片、个人/子账号头像、成长记录图片上传，全部经 `prepareUpload` 处理。
  - 成长记录页面删除直接 `compressAccurately`，改为复用工具函数，保持最小改动。
  - 代码位置：`frontend/src/pages/little-growth/LittleGrowthEdit.vue:185,317–349`
    - `handleFileChange` 内使用 `prepareUpload(file, 0.75)`，上传到后端 `POST /upload/growth-file`。
- 依赖更新与验证
  - 依赖变更：`frontend/package.json:19–35`（删除 `image-conversion`，新增 `browser-image-compression`）
  - 安装与类型检查：
    - 安装：`cd frontend && pnpm install`
    - 类型检查：`pnpm exec tsc --noEmit`
    - 均已通过；前端热加载无需重启。

**影响范围**
- 任务页图片上传与预览：沿用 `prepareUpload`，后端 `resource_type='task_image'`，转换 `webp`，走预签名上传。
  - 代码参考：`frontend/src/services/tasks.ts:131–141`，调用 `prepareUpload(file, 0.75)`
- 备注页附件图片：与任务图片一致，受 VIP 校验。
  - 代码参考：`frontend/src/services/tasks.ts:144–154`，`backend/internal/handlers/storage.go:51–56`
- 心愿图标上传：统一压缩为 `webp` 后上传到 `uploads/images/{user_id}/wish/`。
  - 代码参考：`frontend/src/services/wishes.ts:132–138`，`backend/internal/handlers/storage.go:197–201`
- 头像上传（个人与子账号）：统一转换为 `webp`，上传 `avatars/{user_id}`。
  - 代码参考：`frontend/src/services/user.ts:22–29`，`frontend/src/pages/SubAccountsPage.vue:372–385,389–397`，`backend/internal/handlers/storage.go:176–183`
- 成长记录图片上传：统一压缩入口，仍走 `POST /upload/growth-file`，返回相对路径后拼接基址展示。
  - 代码参考：`frontend/src/pages/little-growth/LittleGrowthEdit.vue:317–349`，`frontend/src/stores/littleGrowth.ts:143–170`

**接口与路径一致性**
- 后端预签名生成 Key 统一规则：
  - `avatar` → `images/{user_id}/avatars/avatar_{user_id}_{ts}_{ns}.webp`
  - `task_image` → `images/{user_id}/task_images/task_{task_id}_{ts}_{ns}.webp`
  - `task_attachment_img` → `images/{user_id}/task_images/img_{user_id}_{task_id}_{ts}_{ns}.webp`
  - `task_attachment_audio` → `images/{user_id}/task_images/audio_{user_id}_{task_id}_{ts}_{ns}.{mp3|wav}`
  - `wish_image` → `images/{user_id}/wish/wish_{user_id}_{ts}_{ns}.webp`
  - 代码参考：`backend/internal/handlers/storage.go:162–202`

**代码检测与优化**
- 关键交互路径检查
  - 所有图片上传入口均复用 `prepareUpload`，避免重复实现与参数不一致问题。
  - VIP 校验路径保留（任务图片/备注图片/备注音频），后端在 `StoragePresign` 与本地 `StoragePut` 入口均有校验。
    - 参考：`backend/internal/handlers/storage.go:51–56,109–133,144–160`
- 算法效率优化
  - 压缩动态目标体积与质量，使用 Web Worker 异步压缩，降低主线程阻塞，提升多选批量体验。
  - 大图统一限制最大边 1920，减小画布尺寸避免超限导致失败。
- 数据一致性验证
  - 上传后返回的 `object_key` 与相对路径 `uploads/...` 渠道保持一致，前端展示时统一用静态基址或预签名视图 URL。
  - 心愿图标与任务图片预览均使用 `normalizeUploadPath` 与 `presignView` 兜底。
    - 参考：`frontend/src/services/wishes.ts:41–53,139–147`；`frontend/src/services/storage.ts:11–14`

**如何验证**
- 在已运行的前端热加载环境下：
  - 任务页添加图片，进度与预览正常，图片体积显著缩小，格式统一为 `webp`。
  - 心愿页更换图标，上传成功后能正常显示；失败时回退占位图。
  - 备注页添加图片与录音，VIP 路径报错信息友好。
  - 我的页与子账号页上传头像，能正常转换与显示。
  - 成长记录页多选图片，上传体验流畅，预览正常。
- 如需命令验证：
  - 安装依赖：`cd frontend && pnpm install`
  - 类型检查：`pnpm exec tsc --noEmit`

**说明与后续**
- 采用 `browser-image-compression` 是基于行业常用方案的合理选择，并且支持 Web Worker 与 `fileType='image/webp'`，满足统一前端压缩为 `webp` 的项目约束。
- 若需进一步微调压缩策略（例如针对头像/心愿图标设定更小目标体积，或按宽高自适配不同上限），可以在 `prepareUpload(file, quality)` 中增加策略分支，不影响现有调用方。