## Windows 开发环境配置 S3（测试用）

- PowerShell 设置环境变量（本地运行后端）
  - 必填
    - $env:STORAGE_DRIVER = "s3"
    - $env:S3_PROVIDER = "aws" 或 "minio"
    - $env:S3_ENDPOINT = "https://s3.amazonaws.com" （AWS）或 "http://localhost:9000" （MinIO）
    - $env:S3_REGION = "us-east-1"
    - $env:S3_BUCKET = "recordgo"
    - $env:S3_ACCESS_KEY_ID = "<你的 Key>"
    - $env:S3_SECRET_ACCESS_KEY = "<你的 Secret>"
  - 可选
    - $env:S3_FORCE_PATH_STYLE = "true" （MinIO 设 true，AWS 设 false）
    - $env:S3_PRESIGN_EXPIRE = "300"
    - $env:S3_PUBLIC_BASE_URL = "https://cdn.example.com" （如绑定 CDN 且公开读）
    - $env:ALLOW_ORIGINS = "http://localhost:5173" （前端开发地址）
    - $env:MAX_UPLOAD_SIZE_MB = "10" 、 $env:ALLOW_MIME = "image/webp,audio/mpeg,audio/wav"
  - 启动后端
    - cd g:\Code\RecordGo\backend
    - go run ./cmd/server
- MinIO 本地快速启动（可选）
  - 安装 Docker 后执行：
    - docker run -d --name minio -p 9000:9000 -p 9001:9001 -e MINIO_ROOT_USER=minio -e MINIO_ROOT_PASSWORD=minio123 minio/minio server /data --console-address ":9001"
  - 后端环境变量对应设置：
    - $env:S3_PROVIDER = "minio"
    - $env:S3_ENDPOINT = "http://localhost:9000"
    - $env:S3_ACCESS_KEY_ID = "minio"
    - $env:S3_SECRET_ACCESS_KEY = "minio123"
    - $env:S3_FORCE_PATH_STYLE = "true"
- S3 桶 CORS 配置示例（允许前端直传）
  - AllowedOrigins: ["http://localhost:5173"]
  - AllowedMethods: ["PUT","GET","HEAD"]
  - AllowedHeaders: ["Content-Type","Authorization","x-amz-acl","x-amz-meta-*"]

可使用 Powershell 整体执行，然后在同一个 powershell 中执行后端启动命令。

```powershell
$env:STORAGE_DRIVER = "s3";$env:S3_PROVIDER = "MinIO-Blog";$env:S3_ENDPOINT = "https://img.xxx.top";$env:S3_REGION = "cn-east-1";$env:S3_BUCKET = "blog";$env:S3_ACCESS_KEY_ID = "xxx";$env:S3_SECRET_ACCESS_KEY = "xxx";$env:S3_FORCE_PATH_STYLE = "true";$env:S3_PRESIGN_EXPIRE = "300";$env:S3_PUBLIC_BASE_URL = "https://img.xxx.top"
```

## 如何测试 S3 直传

- 确认驱动
  - GET /api/storage/info 应返回 { driver: "s3" }
- 前端上传路径验证
  - 头像、心愿图标、任务图片都会先在前端转换为 webp ，再调用 POST /api/storage/presign 获取 upload_url 并向 S3 发起 PUT
  - 完成后调用业务“落库”接口（如 POST /api/upload/avatar/object ）记录 object_key
- 展示地址
  - 对象键不含 uploads/ 的资源，前端将调用 GET /api/storage/presign-view 获取短期可读 URL 展示（已在任务图片与心愿编辑页适配）
    如果你希望我继续在心愿列表、领取记录、我的页头像解析处也统一切换到读签名展示（完整兼容 S3 私有桶），我可以按已有模式补充解析工具与调用并更新页面解析函数。

## docker-compose 变量.env 配置

环境变量示例

- 本地默认
  - STORAGE_DRIVER=local
- S3 启用
  - STORAGE_DRIVER=s3
  - S3_PROVIDER=aws 或 minio
  - S3_ENDPOINT=https://s3.amazonaws.com 或 http://minio:9000
  - S3_REGION=us-east-1
  - S3_BUCKET=recordgo
  - S3_ACCESS_KEY_ID=...
  - S3_SECRET_ACCESS_KEY=...
  - S3_FORCE_PATH_STYLE=true （MinIO 设 true）
  - S3_PRESIGN_EXPIRE=300
  - S3_PUBLIC_BASE_URL=https://cdn.example.com （如公开读走 CDN）
  - MAX_UPLOAD_SIZE_MB=10
  - ALLOW_MIME=image/webp,audio/mpeg,audio/wav
