## 目标
- 任务创建/编辑支持“时间设置（可选）”：按时间段或按时长，Tab/分段切换；任务卡片按填写方式展示。
- 任务金币支持“固定奖励 + 阶梯/加成规则”，并给出易用的录入方式。
- 数据库变更全部通过 ORM（GORM AutoMigrate/Migrator）完成。

## 现状调研结论（基于现有代码）
- 前端创建/编辑页：TaskCreatePage.vue、TaskEditPage.vue；任务卡片在 TasksPage.vue 渲染。
- 目前只有 plan_minutes（计划时长）字段；后端 Task 模型与创建/更新接口均无“时间段”字段。
- 目前金币结算是固定值：完成/打卡一次就按 Task.Score 加减；仓库里不存在 reward_policy_json 实现。
- 迁移策略：后端启动时 db.Init() 调用 AutoMigrate；少量场景用 Migrator().HasColumn/AddColumn 补列。

## 功能设计（时间设置）
- 表单 UI：在“计划用时”处改为分段控件（按时长 / 按时间段）。
  - 按时长：保留现有 plan_minutes 输入。
  - 按时间段：使用 Element Plus 时间范围选择（HH:mm-HH:mm）。
- 持久化策略（推荐：持久化时间段，才能在卡片稳定显示并用于奖励规则）：
  - 新增字段：plan_mode（duration|range）、plan_start_minute、plan_end_minute（0-1439，可跨天），保留 plan_minutes。
  - 后端保存时：
    - duration 模式：只存 plan_minutes；range 字段置空。
    - range 模式：存 start/end；同时计算并写入 plan_minutes（用于统计/番茄钟/列表聚合）。
- 任务卡片展示：
  - 若 plan_mode=range 且 start/end 存在：展示“08:00-08:30（30 分钟）”。
  - 否则：展示“30 分钟”。

## 功能设计（阶梯奖励/加成）
- 规则类型建议（覆盖你举的例子，并易于理解/实现）：
  - 固定基础金币 base。
  - 阶梯（按一次完成内的 minutes）：min_minutes 阈值→奖励金币/倍率（30/60/90…）。
  - 时段倍率（早起/晚睡）：完成发生时间落在某区间→倍率或额外金币。
  - 周末/工作日倍率：按完成日期星期→倍率。
  - 连续天数（streak）：连续完成天数达到阈值→额外金币（7天+2）。
  - 每日首做/第N次：当天第1次完成→额外金币（适合“晨间第一件事”）。
  - 迟到惩罚：超出时间段/超过截止时间→扣金币或倍率降低。
- 录入简化方案（让家长/小朋友更容易配置）：
  - 预设模板：晨间习惯、阅读、运动、早睡、作业、家务（选择模板自动填 base 与常见加成）。
  - “开关 + 少量参数”而不是自由编辑：每个加成用开关启用，参数限制在 1-2 个（例如阈值分钟、倍率）。
  - 实时预览：在创建/编辑页显示“示例收益”小面板（例如 30/60 分钟、周末、6:30 完成时分别是多少金币）。
  - 进阶模式：仅当需要时展开“自定义规则”（JSON 仍可作为底层存储，但 UI 不直接暴露 JSON）。

## 后端实现要点（保证撤销一致性）
- 需要能按“本次完成发生时间”结算时段奖励：给 TaskOccurrence 增加 completed_at（time.Time，可空）。
  - 完成一次时写入 completed_at（默认用服务端当前时间；也可接受前端传入但要校验范围）。
  - 撤销一次时用这条记录的 completed_at 或本次撤销的目标次数来反算扣回金币，保证加减对称。
- 新增 reward_policy（建议 JSON 存储）并抽出统一结算函数：computeCoinsDelta(task, ctx)；替换当前三个入口里的“±Score”。
  - UpdateStatus（普通完成/取消完成）
  - CompleteTaskOccurrence（打卡一次）
  - UncompleteTaskOccurrence（撤销一次打卡）

## 数据迁移（ORM）
- 在 models.Task、models.TaskOccurrence 增加新字段（含 gorm/json tag）。
- 在 db.Init() 的 AutoMigrate 列表确保覆盖相关模型；必要时参考 admin.go 用 Migrator().HasColumn/AddColumn 做集中补列兜底。

## 前端实现要点（文件级改动范围）
- pages/TaskCreatePage.vue、pages/TaskEditPage.vue：替换“计划用时”表单为分段控件，新增字段并随 payload 提交。
- services/tasks.ts：补充新字段的类型与映射。
- pages/TasksPage.vue：卡片副信息区域新增时间段/时长展示。

## 验证与回归
- 前端：创建 duration/range 两种任务→列表卡片展示正确→编辑页回显正确。
- 后端：
  - 新旧数据库启动 AutoMigrate 不报错（新增列存在）。
  - 完成/撤销一次任务金币加减对称。
  - 打卡多次（第N次/分钟阈值/周末）金币结算符合预期。
